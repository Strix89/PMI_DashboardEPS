<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Availability Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff8c00;        /* Arancione dominante */
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #ff6b35;        /* Arancione warning */
            --danger-color: #e74c3c;
            --light-bg: #fafafa;             /* Sfondo pi√π chiaro */
            --dark-bg: #1e1e1e;             /* Scuro pi√π leggibile */
            --text-light: #2c3e50;
            --text-dark: #f5f5f5;           /* Testo scuro pi√π leggibile */
            --accent-orange: #ff8c00;       /* Arancione accent */
            --card-light: #ffffff;          /* Card chiare */
            --card-dark: #2d2d2d;           /* Card scure pi√π leggibili */
        }

        [data-theme="dark"] {
            --light-bg: var(--dark-bg);
            --text-light: var(--text-dark);
            --card-light: var(--card-dark);
            background-color: var(--dark-bg);
            color: var(--text-dark);
        }

        [data-theme="dark"] .card {
            background-color: var(--card-dark);
            border: 1px solid #404040;
            color: var(--text-dark);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .form-control {
            background-color: #404040;
            border-color: #555;
            color: var(--text-dark);
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #404040;
            border-color: var(--accent-orange);
            color: var(--text-dark);
            box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25);
        }

        [data-theme="dark"] .btn-outline-secondary {
            color: var(--text-dark);
            border-color: #555;
        }

        [data-theme="dark"] .btn-outline-secondary:hover {
            background-color: var(--accent-orange);
            border-color: var(--accent-orange);
            color: #fff;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover, .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle i, .back-button i {
            color: var(--accent-orange);
            font-size: 1.2rem;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .config-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--accent-orange), #ff6b35);
            padding: 2rem 0;
        }

        .config-card {
            background: var(--card-light);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .config-card {
            background: var(--card-dark);
            border: 1px solid #404040;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .card {
            background-color: var(--card-light);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 15px;
            position: relative;
            transition: all 0.3s ease;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .step.active {
            background: var(--accent-orange);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
        }

        .step.completed {
            background: var(--success-color);
            color: white;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .step::after {
            content: '';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 3px;
            background: #dee2e6;
            border-radius: 2px;
        }

        .step:last-child::after {
            display: none;
        }

        .service-weight-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .service-weight-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .service-weight-item {
            border-color: #555;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Pulsanti tema arancione */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-orange), #ff6b35);
            border-color: var(--accent-orange);
            font-weight: 600;
            border-radius: 10px;
            padding: 12px 24px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #e67e00, var(--accent-orange));
            border-color: #e67e00;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border-color: var(--success-color);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-secondary {
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
        }

        .weight-slider {
            flex: 1;
        }

        /* Form controls migliorati */
        .form-control {
            border-radius: 10px;
            border: 2px solid #dee2e6;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25);
        }

        .form-select {
            border-radius: 10px;
            border: 2px solid #dee2e6;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-select:focus {
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25);
        }

        /* Stili per slider pi√π visibili */
        .form-range.service-weight {
            height: 10px;
            background: linear-gradient(to right, #e9ecef 0%, var(--accent-orange) 100%);
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        /* Tema scuro - slider */
        [data-theme="dark"] .form-range.service-weight {
            background: linear-gradient(to right, #495057 0%, var(--accent-orange) 100%);
        }

        .form-range.service-weight::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-orange);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .form-range.service-weight::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-orange);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .form-range.service-weight::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.5);
        }

        .weight-value {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--accent-orange);
            min-width: 70px;
            text-align: center;
            padding: 8px 12px;
            background: rgba(255, 140, 0, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(255, 140, 0, 0.2);
        }

        /* Headings arancioni */
        h1, h2, h3, h4, h5 {
            color: var(--accent-orange);
            font-weight: 700;
        }

        [data-theme="dark"] h1, 
        [data-theme="dark"] h2, 
        [data-theme="dark"] h3, 
        [data-theme="dark"] h4, 
        [data-theme="dark"] h5 {
            color: #ffb366;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar-custom {
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #e9ecef;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .error-message {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        [data-theme="dark"] .error-message {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }
    </style>
</head>
<body data-theme="light">
    <button class="back-button btn" onclick="location.href='/availability'" title="Torna alla selezione file">
        <i class="fas fa-arrow-left"></i>
    </button>

    <button class="theme-toggle btn" onclick="toggleTheme()" title="Cambia tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="config-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-xl-6">
                    <div class="config-card p-4">
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                <i class="fas fa-cogs fa-4x" style="color: var(--accent-orange); filter: drop-shadow(0 4px 8px rgba(255, 140, 0, 0.3));"></i>
                            </div>
                            <h1 class="h2 mb-3" style="background: linear-gradient(135deg, var(--accent-orange), #ff6b35); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 900;">
                                Availability Dashboard
                            </h1>
                            <p class="text-muted fs-5">Configura i parametri per l'analisi cumulativa del sistema</p>
                        </div>

                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" id="step1">1</div>
                            <div class="step" id="step2">2</div>
                            <div class="step" id="step3">3</div>
                        </div>

                        <!-- Configurazione Step 1: Error Budget -->
                        <div id="config-step-1" class="config-step">
                            <h4><i class="fas fa-exclamation-triangle me-2" style="color: var(--accent-orange);"></i>Error Budget</h4>
                            <div class="mb-3">
                                <label for="error-budget-input" class="form-label">Error budget globale (numero assoluto di fallimenti) (pool effettuati ogni minuto):</label>
                                <input type="number" class="form-control" id="error-budget-input" 
                                       min="1" max="1000" value="{{ default_config.error_budget }}" 
                                       placeholder="Es. 5, 10, 15" onchange="updateGlobalErrorBudget()">
                                <div class="form-text">Questo valore sar√† applicato inizialmente a tutti i servizi</div>
                            </div>
                            <div id="service-error-budgets">
                                <!-- I servizi verranno popolati dinamicamente -->
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="nextStep(1)">
                                    Avanti <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Configurazione Step 2: Pesi servizi -->
                        <div id="config-step-2" class="config-step" style="display: none;">
                            <h4><i class="fas fa-balance-scale me-2" style="color: var(--accent-orange);"></i>Pesi Servizi</h4>
                            <p class="text-muted">Imposta il peso (criticit√†) di ogni servizio per il calcolo dell'Availability Score aggregato</p>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Somma pesi: <strong id="weights-sum" style="color: var(--accent-orange);">0.00</strong></span>
                                    <button class="btn btn-sm btn-outline-primary" onclick="normalizeWeights()" style="border-color: var(--accent-orange); color: var(--accent-orange);">
                                        <i class="fas fa-balance-scale me-1"></i> Normalizza
                                    </button>
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" id="weights-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div id="service-weights">
                                <!-- I servizi verranno popolati dinamicamente -->
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="nextStep(2)" id="weights-next-btn" disabled>
                                    Avanti <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="prevStep(2)">
                                    <i class="fas fa-arrow-left me-1"></i> Indietro
                                </button>
                            </div>
                        </div>

                        <!-- Configurazione Step 3: Riepilogo -->
                        <div id="config-step-3" class="config-step" style="display: none;">
                            <h4><i class="fas fa-check-circle me-2" style="color: var(--success-color);"></i>Riepilogo Configurazione</h4>
                            <div id="config-summary">
                                <!-- Il riepilogo verr√† popolato dinamicamente -->
                            </div>
                            
                            <div class="d-grid gap-3">
                                <button class="btn btn-success btn-lg" onclick="startAnalysis()" style="border-radius: 15px; padding: 15px; font-size: 1.1rem;">
                                    <i class="fas fa-rocket me-2"></i> Avvia Analisi
                                </button>
                                <button class="btn btn-outline-secondary" onclick="prevStep(3)">
                                    <i class="fas fa-arrow-left me-1"></i> Indietro
                                </button>
                            </div>
                        </div>

                        <div id="error-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="text-center text-white">
            <div class="loading-spinner mb-4"></div>
            <h4 id="loading-title">Generazione analisi in corso...</h4>
            <p id="loading-message">Questo potrebbe richiedere alcuni minuti</p>
            <div class="progress-bar-custom" style="width: 300px;">
                <div class="progress-fill" id="loading-progress" style="width: 0%">0%</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let services = [];

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Configurazione caricata:');
            console.log('‚ùå Error Budget default:', document.getElementById('error-budget-input').value);
            
            loadServices();
        });

        // Gestione tema
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            
            const icon = document.getElementById('theme-icon');
            icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            localStorage.setItem('theme', newTheme);
        }

        // Carica tema salvato
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').className = 
                savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Carica servizi
        async function loadServices() {
            try {
                const response = await fetch('/get_services');
                const data = await response.json();
                if (data.success) {
                    services = data.services;
                    console.log('üéØ SERVIZI CARICATI DAL BACKEND:', services);
                    console.log('üìä Primo servizio esempio:', services[0]);
                    
                    // Popola immediatamente gli error budget dato che lo Step 1 √® visibile
                    populateServiceErrorBudgets();
                } else {
                    showError('Errore nel caricamento dei servizi: ' + data.error);
                }
            } catch (error) {
                showError('Errore di connessione: ' + error.message);
            }
        }

        // Navigazione tra step
        function nextStep(step) {
            if (validateStep(step)) {
                document.getElementById(`config-step-${step}`).style.display = 'none';
                document.getElementById(`step${step}`).classList.remove('active');
                document.getElementById(`step${step}`).classList.add('completed');
                
                currentStep = step + 1;
                document.getElementById(`config-step-${currentStep}`).style.display = 'block';
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // Carica servizi se necessario per gli step 1 e 2
                if ((currentStep === 1 || currentStep === 2) && (!services || services.length === 0)) {
                    loadServices().then(() => {
                        if (currentStep === 1) populateServiceErrorBudgets();
                        if (currentStep === 2) populateServiceWeights();
                    });
                } else {
                    if (currentStep === 1) populateServiceErrorBudgets();
                    if (currentStep === 2) populateServiceWeights();
                    if (currentStep === 3) populateConfigSummary();
                }
            }
        }

        function prevStep(step) {
            document.getElementById(`config-step-${step}`).style.display = 'none';
            document.getElementById(`step${step}`).classList.remove('active');
            
            currentStep = step - 1;
            document.getElementById(`config-step-${currentStep}`).style.display = 'block';
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}`).classList.remove('completed');
        }

        // Validazione step
        function validateStep(step) {
            // Non ci sono pi√π validazioni necessarie dato che abbiamo rimosso i giorni
            return true;
        }

        // Popolamento Error Budgets
        function populateServiceErrorBudgets() {
            const container = document.getElementById('service-error-budgets');
            const globalErrorBudget = document.getElementById('error-budget-input').value;
            
            // Verifica che i servizi siano stati caricati
            if (!services || services.length === 0) {
                console.log('‚ö†Ô∏è Servizi non ancora caricati, riprovando...');
                container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Caricamento servizi...</div>';
                return;
            }
            
            let html = '<h6 class="mt-3 mb-2">Error Budget per servizio:</h6>';
            services.forEach(service => {
                html += `
                    <div class="mb-2">
                        <label class="form-label">${service.name} (${service.status}):</label>
                        <input type="number" class="form-control error-budget-service" 
                               data-service-name="${service.name}" min="1" max="1000" 
                               value="${globalErrorBudget}">
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('‚úÖ Error Budget popolati per', services.length, 'servizi');
        }

        // Aggiorna tutti gli error budget individuali quando cambia quello globale
        function updateGlobalErrorBudget() {
            const globalValue = document.getElementById('error-budget-input').value;
            const serviceInputs = document.querySelectorAll('.error-budget-service');
            serviceInputs.forEach(input => {
                input.value = globalValue;
            });
            console.log('üîÑ Error Budget aggiornati a', globalValue, 'per tutti i servizi');
        }

        // Popolamento Pesi Servizi
        function populateServiceWeights() {
            const container = document.getElementById('service-weights');
            const equalWeight = (1.0 / services.length).toFixed(3);
            
            let html = '';
            services.forEach(service => {
                html += `
                    <div class="service-weight-item">
                        <div style="min-width: 120px;">
                            <strong>${service.name}</strong>
                            <small class="text-muted d-block">Status: ${service.status}</small>
                        </div>
                        <div class="weight-slider">
                            <input type="range" class="form-range service-weight" 
                                   data-service-name="${service.name}" min="0" max="1" 
                                   step="0.001" value="${equalWeight}" 
                                   oninput="updateWeights()">
                        </div>
                        <div style="min-width: 80px; text-align: center;">
                            <span class="weight-value" id="weight-${service.name.replace(/\s+/g, '_')}">${equalWeight}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateWeights();
        }

        // Aggiorna pesi
        function updateWeights() {
            let totalWeight = 0;
            const weights = document.querySelectorAll('.service-weight');
            
            weights.forEach(weight => {
                const value = parseFloat(weight.value);
                totalWeight += value;
                const serviceName = weight.dataset.serviceName.replace(/\s+/g, '_');
                document.getElementById(`weight-${serviceName}`).textContent = value.toFixed(3);
            });
            
            document.getElementById('weights-sum').textContent = totalWeight.toFixed(3);
            
            const progressBar = document.getElementById('weights-progress');
            const percentage = Math.min(100, totalWeight * 100);
            progressBar.style.width = `${percentage}%`;
            
            const nextBtn = document.getElementById('weights-next-btn');
            const isValid = Math.abs(totalWeight - 1.0) < 0.001;
            nextBtn.disabled = !isValid;
            
            if (isValid) {
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-success');
            } else {
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-danger');
            }
        }

        // Normalizza pesi
        function normalizeWeights() {
            const weights = document.querySelectorAll('.service-weight');
            let totalWeight = 0;
            
            weights.forEach(weight => {
                totalWeight += parseFloat(weight.value);
            });
            
            if (totalWeight > 0) {
                weights.forEach(weight => {
                    const normalizedValue = parseFloat(weight.value) / totalWeight;
                    weight.value = normalizedValue.toFixed(3);
                });
                updateWeights();
            }
        }

        // Popolamento riepilogo
        function populateConfigSummary() {
            // Verifica che i servizi siano caricati
            if (!services || services.length === 0) {
                document.getElementById('config-summary').innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                        <p>Caricamento servizi in corso...</p>
                    </div>
                `;
                // Riprova dopo 1 secondo
                setTimeout(populateConfigSummary, 1000);
                return;
            }

            console.log('üìù CREANDO RIEPILOGO CON SERVIZI:', services);
            
            const globalErrorBudget = document.getElementById('error-budget-input').value;
            
            let html = `
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-exclamation-triangle text-primary me-2"></i>Error Budget</h6>
                        <p>Budget globale: <strong>${globalErrorBudget} fallimenti</strong></p>
                        
                        <div class="mb-3">
                            <small class="text-muted">Error Budget per servizio:</small>
                            <div class="row mt-2">
            `;

            // Aggiungi error budget per servizio
            const serviceErrorInputs = document.querySelectorAll('.error-budget-service');
            serviceErrorInputs.forEach((input, index) => {
                const serviceName = input.dataset.serviceName;
                const errorBudget = input.value;
                html += `
                    <div class="col-md-6 mb-1">
                        <small><i class="fas fa-server text-warning me-1"></i>${serviceName}: <strong class="text-warning">${errorBudget}</strong></small>
                    </div>
                `;
            });

            html += `
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-balance-scale text-primary me-2"></i>Pesi Servizi</h6>
                        <div class="row">
            `;
            
            const weights = document.querySelectorAll('.service-weight');
            console.log('üéöÔ∏è SLIDER TROVATI:', weights.length);
            
            weights.forEach((weight, index) => {
                const serviceName = weight.dataset.serviceName;
                const service = services.find(s => s.name === serviceName);
                
                console.log(`üîç Slider ${index + 1}: nome="${serviceName}", servizio trovato:`, service);
                
                if (service) {
                    html += `
                        <div class="col-md-6 mb-2">
                            <small><i class="fas fa-server text-success me-1"></i>${service.name}: <strong class="text-success">${parseFloat(weight.value).toFixed(3)}</strong></small>
                        </div>
                    `;
                } else {
                    // Debug: mostra il nome dal dataset anche se non trova il servizio
                    html += `
                        <div class="col-md-6 mb-2">
                            <small><i class="fas fa-question-circle text-danger me-1"></i>${serviceName || 'Nome mancante'}: <strong class="text-warning">${parseFloat(weight.value).toFixed(3)}</strong></small>
                            <small class="text-muted d-block">‚ö†Ô∏è Servizio non trovato nell'elenco</small>
                        </div>
                    `;
                }
            });
            
            html += `
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Totale servizi configurati: <strong>${weights.length}</strong> | 
                                Servizi nel DB: <strong>${services.length}</strong> |
                                Error Budget configurati: <strong>${serviceErrorInputs.length}</strong>
                            </small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('config-summary').innerHTML = html;
        }

        // Avvia analisi
        async function startAnalysis() {
            const config = collectConfiguration();
            
            showLoading();
            
            try {
                const response = await fetch('/availability/start_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                if (data.success) {
                    checkJobStatus();
                } else {
                    hideLoading();
                    showError('Errore nell\'avvio dell\'analisi: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                showError('Errore di connessione: ' + error.message);
            }
        }

        // Raccoglie la configurazione
        function collectConfiguration() {
            const serviceErrorBudgets = {};
            document.querySelectorAll('.error-budget-service').forEach(input => {
                serviceErrorBudgets[input.dataset.serviceName] = parseInt(input.value);
            });
            
            const serviceWeights = {};
            document.querySelectorAll('.service-weight').forEach(input => {
                serviceWeights[input.dataset.serviceName] = parseFloat(input.value);
            });
            
            return {
                service_error_budgets: serviceErrorBudgets,
                service_weights: serviceWeights
            };
        }

        // Controlla status job
        async function checkJobStatus() {
            try {
                const response = await fetch('/availability/analysis_progress');
                const data = await response.json();
                
                updateLoadingProgress(data.progress);
                
                if (data.status === 'completed') {
                    if (data.result && data.result.success) {
                        window.location.href = '/availability/dashboard';
                    } else {
                        hideLoading();
                        showError('Errore nell\'analisi: ' + (data.result ? data.result.error : 'Errore sconosciuto'));
                    }
                } else if (data.status === 'error') {
                    hideLoading();
                    showError('Errore nell\'analisi: ' + (data.result ? data.result.error : 'Errore sconosciuto'));
                } else {
                    setTimeout(checkJobStatus, 2000);
                }
            } catch (error) {
                hideLoading();
                showError('Errore nel controllo dello status: ' + error.message);
            }
        }

        // Loading overlay
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function updateLoadingProgress(progress) {
            const progressBar = document.getElementById('loading-progress');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress}%`;
        }

        // Gestione errori
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${message}
                </div>
            `;
        }
    </script>
</body>
</html>
