<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resilience Dashboard - Monitoraggio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #ff8c00;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #ff6b35;
            --danger-color: #e74c3c;
            --light-bg: #fafafa;
            --dark-bg: #1a1a1a;
            --text-light: #2c3e50;
            --text-dark: #f0f0f0;
            --accent-orange: #ff8c00;
            --card-light: #ffffff;
            --card-dark: #2a2a2a;
            --border-light: #e0e0e0;
            --border-dark: #404040;
            --muted-light: #6c757d;
            --muted-dark: #adb5bd;
        }

        [data-theme="dark"] {
            --light-bg: var(--dark-bg);
            --text-light: var(--text-dark);
            --card-light: var(--card-dark);
            --border-light: var(--border-dark);
            --muted-light: var(--muted-dark);
            background-color: var(--dark-bg);
            color: var(--text-dark);
        }

        [data-theme="dark"] .card {
            background-color: var(--card-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-dark);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .text-muted {
            color: var(--muted-dark) !important;
        }

        [data-theme="dark"] .border {
            border-color: var(--border-dark) !important;
        }

        [data-theme="dark"] .card-header {
            background-color: rgba(44, 62, 80, 0.8) !important;
            border-bottom: 1px solid var(--border-dark);
        }

        [data-theme="dark"] .btn-outline-secondary {
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        [data-theme="dark"] .btn-outline-secondary:hover {
            background-color: var(--border-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        [data-theme="dark"] .form-range {
            background-color: var(--card-dark);
        }

        [data-theme="dark"] .navbar-nav .nav-link {
            color: var(--text-dark) !important;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.15);
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
            border-bottom: none;
        }

        .card {
            background-color: var(--card-light);
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .chart-container {
            height: 400px;
            width: 100%;
        }

        .resilience-score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin: 0 auto;
        }

        .score-excellent { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .score-good { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .score-acceptable { background: linear-gradient(135deg, #ff6b35, #ff8c00); color: white; }
        .score-critical { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

        .asset-card {
            position: relative;
            transition: all 0.3s ease;
        }

        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .backup-status {
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .backup-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
            vertical-align: middle;
        }

        .backup-dot.success { background-color: #27ae60; }
        .backup-dot.failure { background-color: #e74c3c; }
        .backup-dot.pending { background-color: #95a5a6; }

        .speed-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: 2px solid var(--border-light);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .theme-toggle {
            background: var(--card-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .back-button {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .back-button i {
            color: var(--accent-red);
            font-size: 1.2rem;
        }

        .entity-card {
            border-left: 4px solid #e74c3c;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .entity-card:hover {
            border-left-color: #ff8c00;
            transform: translateX(5px);
        }

        .metric-badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-shield-alt me-2"></i>
                Resilience Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-3" id="currentTime">
                    <i class="fas fa-clock me-1"></i>
                    Caricamento...
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="location.href='/resilience'">
                    <i class="fas fa-home me-1"></i>
                    Home
                </button>
            </div>
        </div>
    </nav>

    <button class="back-button btn" onclick="location.href='/resilience'" title="Torna alla selezione">
        <i class="fas fa-arrow-left"></i>
    </button>

    <button class="theme-toggle btn" onclick="toggleTheme()" title="Cambia tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <!-- Speed Control -->
    <div class="speed-control">
        <div class="card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <label class="form-label me-2 mb-0">Velocit√†:</label>
                    <select class="form-select form-select-sm" id="speedSelect" style="width: auto;">
                        <option value="1">1x (1 ora)</option>
                        <option value="2">2x (2 ore)</option>
                        <option value="3" selected>3x (3 ore)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Resilience Score Aggregato - Grafico a Torta (spostato in alto) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Resilience Score Aggregato - Distribuzione
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="chart-container" id="resilienceDonutChart" style="height: 350px;"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-column h-100 justify-content-center">
                                    <div class="text-center mb-4">
                                        <h2 class="display-4 fw-bold" id="aggregatedScoreDisplay" style="color: #e74c3c;">--</h2>
                                        <h5 class="text-muted" id="aggregatedLevelDisplay">Caricamento...</h5>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="border rounded p-3 mb-2">
                                                <h6 class="text-muted mb-1">Asset Monitorati</h6>
                                                <h4 id="totalAssetsDisplay" class="text-info mb-0">--</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="border rounded p-3 mb-2">
                                                <h6 class="text-muted mb-1">Ora Attuale</h6>
                                                <h4 id="currentHourDisplay" class="text-warning mb-0">H0</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center mt-3">
                            <button class="btn btn-outline-secondary btn-sm me-2" id="playPauseBtn" onclick="togglePlayPause()">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetTimeline()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <div class="btn-group" role="group">
                                <input type="range" class="form-range" id="timelineSlider" min="0" max="167" value="0" style="width: 300px;">
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Ora: <span id="currentHour">0</span> / 168 | 
                                Timestamp: <span id="currentTimestamp">--</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Asset Individuali (inclusi Backup Jobs) -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            Asset Individuali
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="assetsList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                Caricamento dati...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variabili globali
        let dashboardData = null;
        let currentHour = 0;
        let isPlaying = false;
        let playInterval = null;
        let timelineChart = null;
        let speedMultiplier = 3; // Max 3x come richiesto

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadDashboardData();
            
            // Event listeners
            document.getElementById('speedSelect').addEventListener('change', function() {
                speedMultiplier = parseInt(this.value);
                if (isPlaying) {
                    restartPlayback();
                }
            });
            
            document.getElementById('timelineSlider').addEventListener('input', function() {
                currentHour = parseInt(this.value);
                updateDashboard();
            });
        });

        function loadDashboardData() {
            fetch('/resilience/get_dashboard_data')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dashboardData = data.data;
                    initializeDashboard();
                } else {
                    alert('Errore nel caricamento dei dati: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Errore di connessione');
            });
        }

        function initializeDashboard() {
            if (!dashboardData) return;

            // Inizializza periodo simulazione (solo se l'elemento esiste)
            const period = dashboardData.simulation_period;
            const simulationPeriodEl = document.getElementById('simulationPeriod');
            if (simulationPeriodEl) {
                simulationPeriodEl.textContent = `${period.start} - ${period.end}`;
            }

            // Conta asset totali (inclusi backup jobs)
            const assetsCount = Object.keys(dashboardData.individual_assets || {}).length;
            
            // Aggiorna entrambi gli elementi per compatibilit√†
            const totalAssetsEl = document.getElementById('totalAssets');
            const totalAssetsDisplayEl = document.getElementById('totalAssetsDisplay');
            
            if (totalAssetsEl) totalAssetsEl.textContent = assetsCount;
            if (totalAssetsDisplayEl) totalAssetsDisplayEl.textContent = assetsCount;

            // Inizializza chart
            initializeTimelineChart();
            
            // Popola lista asset
            populateAssetsList();
            
            // Update dashboard
            updateDashboard();
        }

        function initializeTimelineChart() {
            const chartDom = document.getElementById('resilienceDonutChart');
            timelineChart = echarts.init(chartDom);
            
            // Configurazione grafico a torta (donut)
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.name === 'Resilience') {
                            return `${params.name}: ${params.value.toFixed(1)}%`;
                        } else {
                            return `${params.name}: ${params.value.toFixed(1)}%`;
                        }
                    }
                },
                legend: {
                    orient: 'horizontal',
                    bottom: '5%',
                    left: 'center',
                    textStyle: {
                        fontSize: 12
                    }
                },
                series: [{
                    name: 'Resilience Score',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['50%', '45%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '18',
                            fontWeight: 'bold',
                            formatter: function(params) {
                                return params.value.toFixed(1) + '%';
                            }
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        {
                            value: 0,
                            name: 'Resilience',
                            itemStyle: {
                                color: '#e74c3c'
                            }
                        },
                        {
                            value: 100,
                            name: 'Mancante',
                            itemStyle: {
                                color: '#ecf0f1',
                                opacity: 0.3
                            }
                        }
                    ]
                }]
            };
            
            timelineChart.setOption(option);
        }

        function populateAssetsList() {
            const container = document.getElementById('assetsList');
            container.innerHTML = '';

            Object.entries(dashboardData.individual_assets || {}).forEach(([assetId, assetData]) => {
                const card = createEntityCard(assetId, assetData, 'asset');
                container.appendChild(card);
            });
        }

        function createEntityCard(entityId, entityData, type) {
            const div = document.createElement('div');
            div.className = 'entity-card card asset-card mb-3';
            
            const hostname = entityData.hostname || entityData.job_name || entityId;
            const assetType = entityData.asset_type || 'unknown';
            
            div.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${hostname}</h6>
                            <small class="text-muted">${entityId} ‚Ä¢ ${assetType}</small>
                            
                            <!-- Informazioni backup in tempo reale -->
                            <div class="mt-2">
                                <div class="row text-start">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Ultimo Backup:</small>
                                        <span class="small fw-bold" id="${entityId}-last-success" style="color: #e74c3c;">Mai</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Target RPO:</small>
                                        <span class="small fw-bold" id="${entityId}-target-rpo">--</span>
                                    </div>
                                </div>
                                <div class="row text-start mt-2">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Successi:</small>
                                        <span class="small text-success fw-bold" id="${entityId}-success-count">0</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Fallimenti:</small>
                                        <span class="small text-danger fw-bold" id="${entityId}-failure-count">0</span>
                                    </div>
                                </div>
                                <div class="backup-status mt-2">
                                    <small class="text-muted d-block mb-1">Storia (ultime 10 ore):</small>
                                    <div id="${entityId}-history">
                                        <!-- Punti backup generati dinamicamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end ms-3">
                            <span class="metric-badge bg-primary text-white d-block mb-1" id="${entityId}-score">--</span>
                            <span class="metric-badge bg-secondary text-white d-block" id="${entityId}-level">--</span>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }

        function updateDashboard() {
            if (!dashboardData) return;

            // Aggiorna timestamp corrente (solo se gli elementi esistono)
            const startTime = new Date(dashboardData.simulation_period.start);
            const currentTime = new Date(startTime.getTime() + currentHour * 60 * 60 * 1000);
            
            const timestampEl = document.getElementById('currentTimestamp');
            const hourEl = document.getElementById('currentHour');
            
            if (timestampEl) timestampEl.textContent = currentTime.toISOString().substr(0, 19);
            if (hourEl) hourEl.textContent = currentHour;

            // Calcola score aggregato per l'ora corrente
            let totalScore = 0;
            let totalEntities = 0;

            // Aggiorna asset individuali (inclusi backup jobs)
            Object.entries(dashboardData.individual_assets || {}).forEach(([assetId, assetData]) => {
                const simulation = assetData.simulation_data;
                if (simulation && simulation[currentHour]) {
                    const hourData = simulation[currentHour];
                    const score = hourData.resilience_score || 0;
                    const level = hourData.resilience_level || 'UNKNOWN';
                    
                    const scoreEl = document.getElementById(`${assetId}-score`);
                    const levelEl = document.getElementById(`${assetId}-level`);
                    
                    if (scoreEl) scoreEl.textContent = (score * 100).toFixed(1) + '%';
                    if (levelEl) {
                        levelEl.textContent = level;
                        levelEl.className = `metric-badge text-white ${getLevelClass(level)}`;
                    }
                    
                    // Aggiorna tooltip
                    updateAssetTooltip(assetId, assetData, currentHour);
                    
                    totalScore += score;
                    totalEntities++;
                }
            });

            // Aggiorna score aggregato
            const aggregatedScore = totalEntities > 0 ? (totalScore / totalEntities) : 0;
            const aggregatedLevel = getResilienceLevel(aggregatedScore);
            
            // Aggiorna elementi del nuovo layout
            document.getElementById('aggregatedScoreDisplay').textContent = (aggregatedScore * 100).toFixed(1) + '%';
            document.getElementById('aggregatedLevelDisplay').textContent = aggregatedLevel;
            document.getElementById('totalAssetsDisplay').textContent = totalEntities;
            document.getElementById('currentHourDisplay').textContent = `H${currentHour}`;
            
            // Mantieni compatibilit√† con il vecchio header se presente
            const oldScoreText = document.getElementById('aggregatedScoreText');
            const oldScoreLevel = document.getElementById('aggregatedScoreLevel');
            const oldScoreCircle = document.getElementById('aggregatedScoreCircle');
            
            if (oldScoreText) oldScoreText.textContent = (aggregatedScore * 100).toFixed(1) + '%';
            if (oldScoreLevel) oldScoreLevel.textContent = aggregatedLevel;
            if (oldScoreCircle) oldScoreCircle.className = `resilience-score-circle score-${aggregatedLevel.toLowerCase()}`;

            // Aggiorna grafico a torta
            updateTimelineChart(aggregatedScore);
            
            // Aggiorna slider
            document.getElementById('timelineSlider').value = currentHour;
        }

        function updateTimelineChart(currentScore) {
            if (!timelineChart) return;
            
            const scorePercentage = currentScore * 100;
            const remainingPercentage = 100 - scorePercentage;
            
            // Determina il colore basato sul livello di resilienza
            let color = '#e74c3c'; // Default rosso (SEVERE)
            if (currentScore >= 0.9) color = '#27ae60'; // Verde (EXCELLENT)
            else if (currentScore >= 0.75) color = '#f39c12'; // Arancione (GOOD)
            else if (currentScore >= 0.6) color = '#3498db'; // Blu (ACCEPTABLE)
            else if (currentScore >= 0.4) color = '#ff6b35'; // Arancione scuro (CRITICAL)
            
            const option = {
                series: [{
                    data: [
                        {
                            value: scorePercentage,
                            name: 'Resilience',
                            itemStyle: {
                                color: color
                            }
                        },
                        {
                            value: remainingPercentage,
                            name: 'Mancante',
                            itemStyle: {
                                color: '#ecf0f1',
                                opacity: 0.3
                            }
                        }
                    ]
                }]
            };
            
            timelineChart.setOption(option, { merge: true });
        }

        function updateAssetTooltip(assetId, assetData, currentHour) {
            const simulation = assetData.simulation_data;
            if (!simulation || !simulation[currentHour]) return;

            const currentData = simulation[currentHour];
            
            // Trova ultimo backup riuscito (non solo con successi > 0, ma quando √® effettivamente avvenuto un backup con successo)
            let lastSuccessTime = 'Mai';
            let lastSuccessFound = false;
            
            for (let i = currentHour; i >= 0; i--) {
                if (simulation[i]) {
                    const hourData = simulation[i];
                    // Controlla se in questa ora √® avvenuto un backup con successo
                    const prevSuccessful = i > 0 ? (simulation[i-1]?.total_backups_successful || 0) : 0;
                    const currentSuccessful = hourData.total_backups_successful || 0;
                    
                    if (currentSuccessful > prevSuccessful) {
                        // In questa ora √® avvenuto almeno un backup con successo
                        const startTime = new Date(dashboardData.simulation_period.start);
                        const successTime = new Date(startTime.getTime() + i * 60 * 60 * 1000);
                        lastSuccessTime = formatDateTime(successTime);
                        lastSuccessFound = true;
                        break;
                    }
                }
            }
            
            // Aggiorna target RPO
            const targetRpoHours = currentData.target_rpo_hours || 24;
            const targetRpoText = `${targetRpoHours}h`;
            
            // Calcola backup cumulativi
            const totalAttempted = currentData.total_backups_attempted || 0;
            const totalSuccessful = currentData.total_backups_successful || 0;
            const totalFailures = totalAttempted - totalSuccessful;
            
            // Aggiorna elementi tooltip
            const lastSuccessEl = document.getElementById(`${assetId}-last-success`);
            const targetRpoEl = document.getElementById(`${assetId}-target-rpo`);
            const successCountEl = document.getElementById(`${assetId}-success-count`);
            const failureCountEl = document.getElementById(`${assetId}-failure-count`);
            
            if (lastSuccessEl) {
                lastSuccessEl.textContent = lastSuccessTime;
                lastSuccessEl.style.color = lastSuccessFound ? '#27ae60' : '#e74c3c';
            }
            if (targetRpoEl) targetRpoEl.textContent = targetRpoText;
            if (successCountEl) successCountEl.textContent = totalSuccessful;
            if (failureCountEl) failureCountEl.textContent = totalFailures;
            
            // Aggiorna storia backup (ultime 20 ore)
            updateBackupHistory(assetId, assetData, currentHour);
        }

        function updateBackupHistory(assetId, assetData, currentHour) {
            const historyEl = document.getElementById(`${assetId}-history`);
            if (!historyEl) return;
            
            historyEl.innerHTML = '';
            
            const simulation = assetData.simulation_data;
            const startHour = Math.max(0, currentHour - 9); // Ultime 10 ore
            
            for (let i = startHour; i <= currentHour; i++) {
                const dot = document.createElement('span');
                dot.className = 'backup-dot';
                dot.title = `Ora ${i}`;
                
                if (simulation[i]) {
                    const hourData = simulation[i];
                    const attempted = i > 0 ? (hourData.total_backups_attempted - (simulation[i-1]?.total_backups_attempted || 0)) : hourData.total_backups_attempted;
                    const successful = i > 0 ? (hourData.total_backups_successful - (simulation[i-1]?.total_backups_successful || 0)) : hourData.total_backups_successful;
                    
                    if (attempted > 0) {
                        if (successful > 0) {
                            dot.classList.add('success');
                            dot.title += ' - Backup riuscito';
                        } else {
                            dot.classList.add('failure');
                            dot.title += ' - Backup fallito';
                        }
                    } else {
                        dot.classList.add('pending');
                        dot.title += ' - Nessun backup';
                    }
                } else {
                    dot.classList.add('pending');
                    dot.title += ' - Nessun dato';
                }
                
                historyEl.appendChild(dot);
            }
        }

        function formatDateTime(date) {
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getLevelClass(level) {
            const levelMap = {
                'EXCELLENT': 'bg-success',
                'GOOD': 'bg-warning',
                'ACCEPTABLE': 'bg-info',
                'CRITICAL': 'bg-danger',
                'SEVERE': 'bg-dark'
            };
            return levelMap[level] || 'bg-secondary';
        }

        function getResilienceLevel(score) {
            if (score >= 0.9) return 'EXCELLENT';
            if (score >= 0.75) return 'GOOD';
            if (score >= 0.6) return 'ACCEPTABLE';
            if (score >= 0.4) return 'CRITICAL';
            return 'SEVERE';
        }

        function togglePlayPause() {
            if (isPlaying) {
                pausePlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            isPlaying = true;
            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pause';
            
            playInterval = setInterval(() => {
                currentHour += speedMultiplier;
                if (currentHour >= 168) {
                    currentHour = 167;
                    pausePlayback();
                }
                updateDashboard();
            }, 1000);
        }

        function pausePlayback() {
            isPlaying = false;
            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i> Play';
            
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        function restartPlayback() {
            if (isPlaying) {
                pausePlayback();
                startPlayback();
            }
        }

        function resetTimeline() {
            pausePlayback();
            currentHour = 0;
            updateDashboard();
        }

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('it-IT');
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const icon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
            }
        }
    </script>
</body>
</html>
