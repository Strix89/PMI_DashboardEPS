<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resilience Dashboard - Configurazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff8c00;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #ff6b35;
            --danger-color: #e74c3c;
            --light-bg: #fafafa;
            --dark-bg: #1e1e1e;
            --text-light: #2c3e50;
            --text-dark: #f5f5f5;
            --accent-red: #e74c3c;  /* Rosso per resilience */
            --card-light: #ffffff;
            --card-dark: #2d2d2d;
        }

        [data-theme="dark"] {
            --light-bg: var(--dark-bg);
            --text-light: var(--text-dark);
            --card-light: var(--card-dark);
            background-color: var(--dark-bg);
            color: var(--text-dark);
        }

        [data-theme="dark"] .card {
            background-color: var(--card-dark);
            border: 1px solid #404040;
            color: var(--text-dark);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .form-control {
            background-color: #404040;
            border-color: #555;
            color: var(--text-dark);
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #404040;
            border-color: var(--accent-red);
            color: var(--text-dark);
            box-shadow: 0 0 0 0.2rem rgba(231, 76, 60, 0.25);
        }

        [data-theme="dark"] .form-select {
            background-color: #404040;
            border-color: #555;
            color: var(--text-dark);
        }

        [data-theme="dark"] .form-range::-webkit-slider-thumb {
            background: var(--accent-red);
        }

        [data-theme="dark"] .form-range::-moz-range-thumb {
            background: var(--accent-red);
        }

        [data-theme="dark"] .text-muted {
            color: #a0a0a0 !important;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--accent-red), #c0392b);
            padding: 2rem 0;
        }

        .config-card {
            background: var(--card-light);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 2rem;
        }

        .step-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .step-item {
            display: flex;
            align-items: center;
            color: #9ca3af;
            transition: all 0.3s ease;
        }

        .step-item.active {
            color: var(--accent-red);
        }

        .step-item.completed {
            color: var(--success-color);
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            margin-right: 1rem;
            transition: all 0.3s ease;
        }

        .step-item.active .step-number {
            background: var(--accent-red);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .step-item.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .step-connector {
            width: 80px;
            height: 3px;
            background: #e5e7eb;
            margin: 0 1rem;
            transition: all 0.3s ease;
        }

        .step-item.completed + .step-connector {
            background: var(--success-color);
        }

        .step-content {
            padding: 2rem;
        }

        .backup-job-card {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .backup-job-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .backup-job-card {
            border-color: #555;
            background: rgba(255, 255, 255, 0.05);
        }

        .backup-weight-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .backup-weight-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .backup-weight-item {
            border-color: #555;
            background: rgba(255, 255, 255, 0.05);
        }

        .backup-info {
            flex-grow: 1;
        }

        /* Stili per la validazione */
        .rpo-input.is-invalid,
        .global-rpo-input.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .rpo-input.is-valid,
        .global-rpo-input.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }

        .validation-alert {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rpo-config-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .rpo-config-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .rpo-config-item {
            border-color: #555;
            background: rgba(255, 255, 255, 0.05);
        }

        .job-info {
            flex-grow: 1;
        }

        .backup-weights-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 400px;
        }

        .weight-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 150px;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--card-light);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-red), #c0392b);
            border-color: var(--accent-red);
            font-weight: 600;
            border-radius: 10px;
            padding: 12px 24px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #c0392b, var(--accent-red));
            border-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .progress {
            height: 8px;
            border-radius: 20px;
            background-color: #e9ecef;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-red), #c0392b);
            transition: width 0.3s ease;
        }

        .metric-weight-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .weight-label {
            min-width: 150px;
            font-weight: 600;
        }

        .weight-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: var(--accent-red);
        }

        .form-range {
            flex-grow: 1;
        }

        .rpo-config-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .rpo-config-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .rpo-config-item {
            border-color: #555;
            background: rgba(255, 255, 255, 0.05);
        }

        .job-info {
            flex-grow: 1;
        }

        .job-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
        }
    </style>
</head>
<body data-theme="light">
    <button class="back-button btn" onclick="location.href='/resilience'" title="Torna alla selezione">
        <i class="fas fa-arrow-left"></i>
    </button>

    <button class="theme-toggle btn" onclick="toggleTheme()" title="Cambia tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="main-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="config-card">
                        <div class="card-header bg-danger text-white text-center py-4">
                            <h2 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                Configurazione Analisi Resilience
                            </h2>
                            <p class="mb-0 mt-2">Configura pesi metriche e RPO per l'analisi di resilience</p>
                        </div>

                        <div class="card-body p-0">
                            <!-- Step Navigation -->
                            <div class="step-nav">
                                <div class="step-item active" id="step-1-nav">
                                    <div class="step-number">1</div>
                                    <div class="step-text">
                                        <div class="fw-bold">Pesi Globali</div>
                                        <small class="text-muted">Configura metriche globali</small>
                                    </div>
                                </div>
                                <div class="step-connector"></div>
                                <div class="step-item" id="step-2-nav">
                                    <div class="step-number">2</div>
                                    <div class="step-text">
                                        <div class="fw-bold">Backup Jobs</div>
                                        <small class="text-muted">Configura RPO e criticità</small>
                                    </div>
                                </div>
                                <div class="step-connector"></div>
                                <div class="step-item" id="step-3-nav">
                                    <div class="step-number">3</div>
                                    <div class="step-text">
                                        <div class="fw-bold">Riepilogo</div>
                                        <small class="text-muted">Avvia analisi</small>
                                    </div>
                                </div>
                            </div>

            <!-- Step 1: Pesi Globali -->
            <div class="step-content" id="step-1-content">
                <h4><i class="fas fa-balance-scale me-2" style="color: var(--accent-red);"></i>Step 1: Configurazione Pesi per Backup</h4>
                <p class="text-muted">Configura i pesi RPO Compliance e Success Rate per ogni backup (jobs, VM, LXC)</p>

                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Configurazione Globale (Opzionale)</h6>
                    <p class="mb-3">Usa questi controlli per applicare gli stessi pesi a tutti i backup, poi personalizza individualmente se necessario.</p>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Peso RPO Compliance Globale</label>
                            <input type="range" class="form-range" id="global-weight-rpo" min="0" max="1" step="0.1" value="0.6">
                            <div class="d-flex justify-content-between">
                                <small>0.0</small>
                                <span id="global-weight-rpo-value" class="fw-bold text-danger">0.6</span>
                                <small>1.0</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Peso Success Rate Globale</label>
                            <input type="range" class="form-range" id="global-weight-success" min="0" max="1" step="0.1" value="0.4">
                            <div class="d-flex justify-content-between">
                                <small>0.0</small>
                                <span id="global-weight-success-value" class="fw-bold text-danger">0.4</span>
                                <small>1.0</small>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-outline-danger" onclick="applyGlobalWeights()">
                                <i class="fas fa-magic me-2"></i>
                                Applica a Tutti
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> Per ogni backup, la somma dei pesi (RPO + Success) deve essere 1.0
                    </div>
                </div>

                <div id="backup-weights-config">
                    <h5><i class="fas fa-cogs me-2"></i>Pesi Individuali per Backup</h5>
                    <p class="text-muted">Configura i pesi specifici per ogni backup job e macchina (VM/LXC)</p>
                    <div id="backup-weights-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Caricamento backup...</p>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Spiegazione Pesi</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>RPO Compliance:</strong></p>
                                        <ul>
                                            <li>Misura quanto bene i backup rispettano i target RPO</li>
                                            <li>Peso alto = priorità alla tempistica dei backup</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Success Rate:</strong></p>
                                        <ul>
                                            <li>Percentuale di backup completati con successo</li>
                                            <li>Peso alto = priorità all'affidabilità dei backup</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-primary" onclick="nextStep(2)">
                        <i class="fas fa-arrow-right me-2"></i>
                        Avanti
                    </button>
                </div>
            </div>            <!-- Step 2: Configurazione Backup Jobs -->
            <div class="step-content d-none" id="step-2-content">
                <h4><i class="fas fa-briefcase me-2" style="color: var(--accent-red);"></i>Step 2: Target RPO Backup Jobs</h4>
                <p class="text-muted">Configura il target RPO (Recovery Point Objective) per ogni backup job in ore.</p>
                
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>RPO (Recovery Point Objective):</strong> Il tempo massimo accettabile tra backup consecutivi.
                    <ul class="mb-0 mt-2">
                        <li><strong>24 ore:</strong> Backup giornaliero (perdita massima di 1 giorno di dati)</li>
                        <li><strong>12 ore:</strong> Backup ogni 12 ore (perdita massima di mezza giornata)</li>
                        <li><strong>4 ore:</strong> Backup frequenti per dati critici</li>
                    </ul>
                </div>                <div class="alert alert-info mb-4">
                    <h6><i class="fas fa-lightbulb me-2"></i>Configurazione Rapida (Opzionale)</h6>
                    <p class="mb-3">Usa questo controllo per applicare velocemente lo stesso RPO a tutti i backup jobs, poi personalizza individualmente se necessario.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Target RPO Default (ore)</label>
                            <input type="number" class="form-control global-rpo-input" id="default-rpo" value="24" min="1" max="168" required>
                            <div class="invalid-feedback">
                                Il valore RPO deve essere tra 1 e 168 ore
                            </div>
                            <div class="form-text">Esempio: 24 ore per backup giornalieri standard</div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-outline-danger" onclick="applyDefaultRPO()">
                                <i class="fas fa-magic me-2"></i>
                                Applica RPO a Tutti
                            </button>
                        </div>
                    </div>
                </div>

                <div id="backup-jobs-config">
                    <h5><i class="fas fa-cogs me-2"></i>Target RPO per Backup Job</h5>
                    <p class="text-muted">Configura il target RPO specifico per ogni backup job in base ai requisiti di business.</p>
                    <div id="backup-jobs-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Caricamento backup jobs...</p>
                        </div>
                    </div>
                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-secondary" onclick="prevStep(1)">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Indietro
                                    </button>
                                    <button class="btn btn-primary" onclick="nextStep(3)">
                                        <i class="fas fa-arrow-right me-2"></i>
                                        Avanti
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: Riepilogo e Avvio -->
                            <div class="step-content d-none" id="step-3-content">
                                <h4><i class="fas fa-check-circle me-2" style="color: var(--accent-red);"></i>Step 3: Riepilogo Configurazione</h4>
                                <p class="text-muted">Verifica la configurazione e avvia l'analisi di resilience</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Pesi Globali</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="summary-weights"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0">Backup Jobs</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="summary-jobs"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-secondary" onclick="prevStep(2)">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Indietro
                                    </button>
                                    <button class="btn btn-success" onclick="startAnalysis()">
                                        <i class="fas fa-rocket me-2"></i>
                                        Avvia Analisi Resilience
                                    </button>
                                </div>
                            </div>

                            <!-- Progress Modal -->
                            <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">
                                                <i class="fas fa-cogs me-2"></i>
                                                Analisi in Corso
                                            </h5>
                                        </div>
                                        <div class="modal-body text-center">
                                            <div class="progress mb-3">
                                                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                                            </div>
                                            <p id="progress-text">Inizializzazione...</p>
                                            <div class="spinner-border text-danger" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let backupJobs = [];
        let allBackups = []; // Tutti i backup individuali (jobs + VM/LXC)

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            loadBackupJobs();
            loadAllBackups();
            setupWeightListeners();
        });

        // Carica tutti i backup individuali dal server
        async function loadAllBackups() {
            try {
                // In futuro: const response = await fetch('/resilience/get_all_backups');
                // Per ora usa dati mock basati sulla struttura JSON
                allBackups = [
                    // Backup Jobs
                    { 
                        id: 'backup-job-001', 
                        name: 'Daily VM Backup', 
                        type: 'backup_job',
                        category: 'Backup Jobs'
                    },
                    { 
                        id: 'backup-job-002', 
                        name: 'Weekly Full Backup', 
                        type: 'backup_job',
                        category: 'Backup Jobs'
                    },
                    // VM Backups
                    { 
                        id: 'vm-101', 
                        name: 'DB-SERVER-PROD', 
                        type: 'vm',
                        category: 'VM Backups'
                    },
                    { 
                        id: 'vm-102', 
                        name: 'WEB-SERVER-01', 
                        type: 'vm',
                        category: 'VM Backups'
                    },
                    { 
                        id: 'vm-103', 
                        name: 'APP-SERVER-JAVA', 
                        type: 'vm',
                        category: 'VM Backups'
                    },
                    { 
                        id: 'vm-104', 
                        name: 'DEV-SERVER-01', 
                        type: 'vm',
                        category: 'VM Backups'
                    },
                    { 
                        id: 'vm-105', 
                        name: 'MAIL-SERVER-01', 
                        type: 'vm',
                        category: 'VM Backups'
                    },
                    // Container Backups
                    { 
                        id: 'ct-201', 
                        name: 'CACHE-SERVER-01', 
                        type: 'container',
                        category: 'Container Backups'
                    },
                    { 
                        id: 'ct-202', 
                        name: 'MONITORING-01', 
                        type: 'container',
                        category: 'Container Backups'
                    },
                    // Physical Host Backups
                    { 
                        id: 'physical-01', 
                        name: 'BACKUP-SERVER-01', 
                        type: 'physical_host',
                        category: 'Physical Host Backups'
                    },
                    { 
                        id: 'physical-02', 
                        name: 'NAS-SERVER-01', 
                        type: 'physical_host',
                        category: 'Physical Host Backups'
                    },
                    // Proxmox Node Backups
                    { 
                        id: 'pve-node-01', 
                        name: 'PVE-HOST-01', 
                        type: 'proxmox_node',
                        category: 'Proxmox Node Backups'
                    }
                ];
                populateBackupWeights();
                populateBackupJobsConfig(); // Aggiungi questa chiamata
            } catch (error) {
                console.error('Errore nel caricamento backup:', error);
            }
        }

        function populateBackupWeights() {
            const container = document.getElementById('backup-weights-list');
            container.innerHTML = '';

            if (allBackups.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nessun backup trovato nel sistema.</p>
                    </div>
                `;
                return;
            }

            // Raggruppa per categoria
            const categories = [...new Set(allBackups.map(b => b.category))];
            
            categories.forEach(category => {
                const categoryBackups = allBackups.filter(b => b.category === category);
                
                // Header categoria
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'mt-4 mb-3';
                categoryHeader.innerHTML = `
                    <h6 class="text-muted mb-2">
                        <i class="fas ${getCategoryIcon(category)} me-2"></i>
                        ${category} (${categoryBackups.length})
                    </h6>
                    <hr>
                `;
                container.appendChild(categoryHeader);

                // Backup della categoria
                categoryBackups.forEach(backup => {
                    const div = document.createElement('div');
                    div.className = 'backup-weight-item';
                    div.innerHTML = `
                        <div class="backup-info">
                            <h6 class="mb-1">${backup.name}</h6>
                            <small class="text-muted">
                                <i class="fas ${getTypeIcon(backup.type)} me-1"></i>
                                ID: ${backup.id} | Tipo: ${backup.type}
                            </small>
                        </div>
                        <div class="backup-weights-controls">
                            <div class="weight-control-group">
                                <label class="form-label mb-1">RPO Weight</label>
                                <input type="range" class="form-range" id="rpo-weight-${backup.id}" min="0" max="1" step="0.1" value="0.6">
                                <span id="rpo-weight-value-${backup.id}" class="fw-bold text-danger">0.6</span>
                            </div>
                            <div class="weight-control-group">
                                <label class="form-label mb-1">Success Weight (automatico)</label>
                                <input type="range" class="form-range" id="success-weight-${backup.id}" min="0" max="1" step="0.1" value="0.4" disabled>
                                <span id="success-weight-value-${backup.id}" class="fw-bold text-secondary">0.4</span>
                            </div>
                            <div class="text-center">
                                <small class="text-muted">Somma:</small>
                                <div id="sum-${backup.id}" class="fw-bold text-success">1.0</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);

                    // Aggiungi listeners per aggiornare i valori
                    document.getElementById(`rpo-weight-${backup.id}`).addEventListener('input', function() {
                        updateBackupWeights(backup.id);
                    });
                });
            });
        }

        function getCategoryIcon(category) {
            switch(category) {
                case 'Backup Jobs': return 'fa-briefcase';
                case 'VM Backups': return 'fa-desktop';
                case 'LXC Backups': return 'fa-cube';
                default: return 'fa-server';
            }
        }

        function getTypeIcon(type) {
            switch(type) {
                case 'backup_job': return 'fa-briefcase';
                case 'vm': return 'fa-desktop';
                case 'lxc': return 'fa-cube';
                default: return 'fa-server';
            }
        }

        function updateBackupWeights(backupId) {
            const rpoWeight = parseFloat(document.getElementById(`rpo-weight-${backupId}`).value);
            const successWeight = 1.0 - rpoWeight; // Mantieni automaticamente la somma a 1.0
            
            // Aggiorna il success weight automaticamente
            document.getElementById(`success-weight-${backupId}`).value = successWeight.toFixed(1);
            
            document.getElementById(`rpo-weight-value-${backupId}`).textContent = rpoWeight.toFixed(1);
            document.getElementById(`success-weight-value-${backupId}`).textContent = successWeight.toFixed(1);
            
            const sumElement = document.getElementById(`sum-${backupId}`);
            sumElement.textContent = '1.0'; // Sempre 1.0
            sumElement.className = 'fw-bold text-success';
        }

        function applyGlobalWeights() {
            const globalRpoWeight = parseFloat(document.getElementById('global-weight-rpo').value);
            
            allBackups.forEach(backup => {
                const rpoInput = document.getElementById(`rpo-weight-${backup.id}`);
                
                if (rpoInput) {
                    rpoInput.value = globalRpoWeight.toFixed(1);
                    updateBackupWeights(backup.id);
                }
            });
        }
        async function loadBackupJobs() {
            try {
                const response = await fetch('/resilience/get_backup_jobs');
                const data = await response.json();
                
                if (data.success) {
                    backupJobs = data.backup_jobs;
                    populateBackupJobsConfig();
                } else {
                    console.error('Errore nel caricamento backup jobs:', data.error);
                    // Usa dati mock se non riesce a caricare dal server
                    backupJobs = [
                        { 
                            asset_id: 'backup_job_1', 
                            name: 'Critical Database Backup', 
                            asset_type: 'acronis_backup_job',
                            data: { job_name: 'Critical Database Backup', status: 'active' }
                        },
                        { 
                            asset_id: 'backup_job_2', 
                            name: 'File Server Backup', 
                            asset_type: 'acronis_backup_job',
                            data: { job_name: 'File Server Backup', status: 'active' }
                        }
                    ];
                    populateBackupJobsConfig();
                }
            } catch (error) {
                console.error('Errore nel caricamento backup jobs:', error);
                // Fallback ai dati mock
                backupJobs = [
                    { 
                        asset_id: 'backup_job_1', 
                        name: 'Critical Database Backup', 
                        asset_type: 'acronis_backup_job',
                        data: { job_name: 'Critical Database Backup', status: 'active' }
                    }
                ];
                populateBackupJobsConfig();
            }
        }

        function populateBackupJobsConfig() {
            const container = document.getElementById('backup-jobs-list');
            container.innerHTML = '';

            // Usa tutti i backup (allBackups) invece che solo backupJobs
            if (allBackups.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nessun backup trovato nel sistema.</p>
                        <small>Configura dei backup prima di procedere con l'analisi.</small>
                    </div>
                `;
                return;
            }

            // Raggruppa per categoria
            const categories = [...new Set(allBackups.map(b => b.category))];
            
            categories.forEach(category => {
                const categoryBackups = allBackups.filter(b => b.category === category);
                
                // Header categoria
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'mt-4 mb-3';
                categoryHeader.innerHTML = `
                    <h6 class="text-muted mb-2">
                        <i class="fas ${getCategoryIcon(category)} me-2"></i>
                        ${category} (${categoryBackups.length})
                    </h6>
                    <hr>
                `;
                container.appendChild(categoryHeader);

                // Backup della categoria
                categoryBackups.forEach(backup => {
                    const div = document.createElement('div');
                    div.className = 'rpo-config-item';
                    div.innerHTML = `
                        <div class="job-info">
                            <h6 class="mb-1">${backup.name}</h6>
                            <small class="text-muted">
                                <i class="fas ${getTypeIcon(backup.type)} me-1"></i>
                                ID: ${backup.id} | Tipo: ${backup.type}
                            </small>
                        </div>
                        <div class="job-controls">
                            <div style="min-width: 200px;">
                                <label class="form-label mb-1">Target RPO (ore)</label>
                                <input type="number" class="form-control rpo-input" id="rpo-${backup.id}" value="24" min="1" max="168" required>
                                <div class="invalid-feedback" id="rpo-error-${backup.id}">
                                    Il valore RPO deve essere tra 1 e 168 ore
                                </div>
                                <div class="form-text">Recovery Point Objective target (1-168 ore)</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function setupWeightListeners() {
            // Listener per pesi globali
            const globalRpoSlider = document.getElementById('global-weight-rpo');
            const globalSuccessSlider = document.getElementById('global-weight-success');
            
            if (globalRpoSlider && globalSuccessSlider) {
                globalRpoSlider.addEventListener('input', function() {
                    const rpoValue = parseFloat(this.value);
                    const successValue = 1.0 - rpoValue;
                    
                    globalSuccessSlider.value = successValue.toFixed(1);
                    document.getElementById('global-weight-rpo-value').textContent = rpoValue.toFixed(1);
                    document.getElementById('global-weight-success-value').textContent = successValue.toFixed(1);
                });

                globalSuccessSlider.addEventListener('input', function() {
                    const successValue = parseFloat(this.value);
                    const rpoValue = 1.0 - successValue;
                    
                    globalRpoSlider.value = rpoValue.toFixed(1);
                    document.getElementById('global-weight-rpo-value').textContent = rpoValue.toFixed(1);
                    document.getElementById('global-weight-success-value').textContent = successValue.toFixed(1);
                });
            }
            
            // Listener per pesi individuali (Step 3)
            const weightRpo = document.getElementById('weight-rpo');
            const weightSuccess = document.getElementById('weight-success');
            const valueRpo = document.getElementById('weight-rpo-value');
            const valueSuccess = document.getElementById('weight-success-value');

            if (weightRpo && weightSuccess && valueRpo && valueSuccess) {
                weightRpo.addEventListener('input', function() {
                    const rpoValue = parseFloat(this.value);
                    const successValue = 1.0 - rpoValue;
                    
                    weightSuccess.value = successValue.toFixed(1);
                    valueRpo.textContent = rpoValue.toFixed(1);
                    valueSuccess.textContent = successValue.toFixed(1);
                });

                weightSuccess.addEventListener('input', function() {
                    const successValue = parseFloat(this.value);
                    const rpoValue = 1.0 - successValue;
                    
                    weightRpo.value = rpoValue.toFixed(1);
                    valueRpo.textContent = rpoValue.toFixed(1);
                    valueSuccess.textContent = successValue.toFixed(1);
                });
            }
        }

        function applyDefaultRPO() {
            const defaultRpoInput = document.getElementById('default-rpo');
            const defaultRpo = parseInt(defaultRpoInput.value);
            
            // Valida il valore RPO globale
            if (isNaN(defaultRpo) || defaultRpo < 1 || defaultRpo > 168) {
                defaultRpoInput.classList.add('is-invalid');
                showValidationMessage('Il valore RPO globale deve essere tra 1 e 168 ore.', 'error');
                return;
            }
            
            defaultRpoInput.classList.remove('is-invalid');
            defaultRpoInput.classList.add('is-valid');
            
            // Applica a tutti i backup
            let appliedCount = 0;
            allBackups.forEach(backup => {
                const rpoInput = document.getElementById(`rpo-${backup.id}`);
                if (rpoInput) {
                    rpoInput.value = defaultRpo;
                    validateRPOInput(backup.id); // Valida anche il campo individuale
                    appliedCount++;
                }
            });
            
            // Mostra messaggio di conferma
            showValidationMessage(`RPO di ${defaultRpo} ore applicato a ${appliedCount} backup.`, 'success');
        }

        function nextStep(step) {
            // Salva lo stato del passo corrente
            if (currentStep === 2) {
                updateSummary();
            }

            // Aggiorna navigazione
            document.getElementById(`step-${currentStep}-nav`).classList.remove('active');
            document.getElementById(`step-${currentStep}-nav`).classList.add('completed');
            document.getElementById(`step-${currentStep}-content`).classList.add('d-none');

            currentStep = step;
            document.getElementById(`step-${currentStep}-nav`).classList.add('active');
            document.getElementById(`step-${currentStep}-content`).classList.remove('d-none');
        }

        function prevStep(step) {
            document.getElementById(`step-${currentStep}-nav`).classList.remove('active');
            document.getElementById(`step-${currentStep}-content`).classList.add('d-none');

            currentStep = step;
            document.getElementById(`step-${currentStep}-nav`).classList.add('active');
            document.getElementById(`step-${currentStep}-nav`).classList.remove('completed');
            document.getElementById(`step-${currentStep}-content`).classList.remove('d-none');
        }

        function updateSummary() {
            // Aggiorna riepilogo pesi per backup
            let weightsHtml = `<h6>Pesi Backup Configurati (${allBackups.length})</h6>`;
            
            if (allBackups.length > 0) {
                const categories = [...new Set(allBackups.map(b => b.category))];
                
                categories.forEach(category => {
                    const categoryBackups = allBackups.filter(b => b.category === category);
                    weightsHtml += `
                        <div class="mt-3">
                            <strong>${category}:</strong>
                            <ul class="list-unstyled ms-3">
                    `;
                    
                    categoryBackups.forEach(backup => {
                        const rpoWeight = document.getElementById(`rpo-weight-value-${backup.id}`)?.textContent || '0.6';
                        const successWeight = document.getElementById(`success-weight-value-${backup.id}`)?.textContent || '0.4';
                        weightsHtml += `<li><small>${backup.name}: RPO=${rpoWeight}, Success=${successWeight}</small></li>`;
                    });
                    
                    weightsHtml += '</ul></div>';
                });
            }
            
            document.getElementById('summary-weights').innerHTML = weightsHtml;

            // Aggiorna riepilogo backup RPO per tutti i backup
            let jobsHtml = `<h6>Target RPO Configurati (${allBackups.length})</h6>`;
            if (allBackups.length > 0) {
                const categories = [...new Set(allBackups.map(b => b.category))];
                
                categories.forEach(category => {
                    const categoryBackups = allBackups.filter(b => b.category === category);
                    jobsHtml += `
                        <div class="mt-3">
                            <strong>${category}:</strong>
                            <ul class="list-unstyled ms-3">
                    `;
                    
                    categoryBackups.forEach(backup => {
                        const rpo = document.getElementById(`rpo-${backup.id}`)?.value || '24';
                        jobsHtml += `<li><small>${backup.name}: RPO ${rpo}h</small></li>`;
                    });
                    
                    jobsHtml += '</ul></div>';
                });
            }
            document.getElementById('summary-jobs').innerHTML = jobsHtml;
        }

        async function startAnalysis() {
            // Valida tutti i campi prima di procedere
            if (!validateAllRPOInputs()) {
                showValidationMessage('Correggi tutti gli errori di validazione prima di avviare l\'analisi.', 'error');
                return;
            }

            // Raccogli configurazione nel formato richiesto dall'analyzer
            const config = {
                asset_rpo_targets: {},
                backup_job_rpo_targets: {},
                asset_weights: {},
                backup_job_weights: {}
            };

            // Raccogli pesi e RPO per tutti i backup
            allBackups.forEach(backup => {
                const rpoWeight = parseFloat(document.getElementById(`rpo-weight-${backup.id}`)?.value || 0.6);
                const successWeight = parseFloat(document.getElementById(`success-weight-${backup.id}`)?.value || 0.4);
                const rpoInput = document.getElementById(`rpo-${backup.id}`);
                const rpo = parseInt(rpoInput?.value || 24);
                
                // Validazione aggiuntiva: assicurati che RPO sia valido
                if (isNaN(rpo) || rpo < 1 || rpo > 168) {
                    showValidationMessage(`RPO non valido per ${backup.name}: deve essere tra 1 e 168 ore.`, 'error');
                    return;
                }
                
                // Separa tra asset e backup jobs secondo la logica dell'analyzer
                // Gestisce tutti i tipi di backup job: 'backup_job', 'acronis_backup_job', etc.
                const isBackupJob = backup.type === 'backup_job' || backup.type === 'acronis_backup_job' || 
                                   backup.type.toLowerCase().includes('backup');
                
                if (isBackupJob) {
                    // È un backup job
                    config.backup_job_rpo_targets[backup.id] = rpo;
                    config.backup_job_weights[backup.id] = {
                        w_rpo: rpoWeight,
                        w_success: successWeight
                    };
                    console.log(`✅ ${backup.name} (${backup.id}, type: ${backup.type}) → BACKUP JOB`);
                } else {
                    // È un asset (VM, LXC, etc.)
                    config.asset_rpo_targets[backup.id] = rpo;
                    config.asset_weights[backup.id] = {
                        w_rpo: rpoWeight,
                        w_success: successWeight
                    };
                    console.log(`📁 ${backup.name} (${backup.id}, type: ${backup.type}) → ASSET`);
                }
            });

            // Log della configurazione per debug
            console.log('📤 Configurazione inviata all\'analyzer:');
            console.log(`   Asset RPO targets: ${Object.keys(config.asset_rpo_targets).length} entries`, config.asset_rpo_targets);
            console.log(`   Backup Job RPO targets: ${Object.keys(config.backup_job_rpo_targets).length} entries`, config.backup_job_rpo_targets);
            console.log(`   Asset weights: ${Object.keys(config.asset_weights).length} entries`);
            console.log(`   Backup Job weights: ${Object.keys(config.backup_job_weights).length} entries`);
            console.log('   Full config:', config);

            // Mostra progress modal
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();

            try {
                // Invia configurazione e avvia analisi
                const response = await fetch('/resilience/start_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    // Monitora progresso
                    monitorProgress();
                } else {
                    throw new Error('Errore nell\'avvio dell\'analisi');
                }
            } catch (error) {
                modal.hide();
                alert('Errore: ' + error.message);
            }
        }

        async function monitorProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            try {
                const response = await fetch('/resilience/analysis_progress');
                const data = await response.json();

                progressBar.style.width = data.progress + '%';
                progressText.textContent = data.status;

                if (data.status === 'completed') {
                    setTimeout(() => {
                        window.location.href = '/resilience/dashboard';
                    }, 1000);
                } else if (data.status === 'failed') {
                    alert('Analisi fallita: ' + data.error);
                    bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
                } else {
                    // Continua il monitoraggio
                    setTimeout(monitorProgress, 1000);
                }
            } catch (error) {
                console.error('Errore nel monitoraggio:', error);
                setTimeout(monitorProgress, 2000);
            }
        }

        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const icon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                icon.className = 'fas fa-sun';
            }
        }

        // ===== FUNZIONI DI VALIDAZIONE =====
        
        function validateRPOInput(backupId) {
            const input = document.getElementById(`rpo-${backupId}`);
            const errorDiv = document.getElementById(`rpo-error-${backupId}`);
            const value = parseInt(input.value);
            
            if (isNaN(value) || value < 1 || value > 168) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                if (errorDiv) {
                    if (isNaN(value) || value <= 0) {
                        errorDiv.textContent = 'Il valore RPO deve essere maggiore di 0';
                    } else if (value > 168) {
                        errorDiv.textContent = 'Il valore RPO non può superare 168 ore (1 settimana)';
                    }
                }
                return false;
            } else {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                return true;
            }
        }

        function validateAllRPOInputs() {
            let allValid = true;
            allBackups.forEach(backup => {
                if (!validateRPOInput(backup.id)) {
                    allValid = false;
                }
            });
            return allValid;
        }

        function validateStep(stepNumber) {
            switch(stepNumber) {
                case 1:
                    // Step 1 è sempre valido (pesi automatici)
                    return true;
                case 2:
                    // Valida tutti i campi RPO
                    return validateAllRPOInputs();
                case 3:
                    // Step 3 è il riepilogo, sempre valido se arriviamo qui
                    return true;
                default:
                    return true;
            }
        }

        function showValidationMessage(message, type = 'warning') {
            let alertClass, icon;
            
            switch(type) {
                case 'error':
                    alertClass = 'alert-danger';
                    icon = 'fa-exclamation-triangle';
                    break;
                case 'info':
                    alertClass = 'alert-info';
                    icon = 'fa-info-circle';
                    break;
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'fa-check-circle';
                    break;
                default:
                    alertClass = 'alert-warning';
                    icon = 'fa-exclamation-circle';
            }
            
            // Rimuovi messaggi precedenti
            const existingAlert = document.querySelector('.validation-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Crea nuovo messaggio
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} validation-alert mt-3`;
            alertDiv.innerHTML = `
                <i class="fas ${icon} me-2"></i>
                ${message}
            `;
            
            // Inserisci prima dei bottoni di navigazione
            const currentStep = document.querySelector('.step-content:not(.d-none)');
            const buttons = currentStep.querySelector('.d-flex.justify-content-between');
            if (buttons) {
                buttons.parentNode.insertBefore(alertDiv, buttons);
            }
            
            // Auto-rimuovi dopo 5 secondi
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Aggiungi validazione alle funzioni di navigazione
        function nextStep(step) {
            const currentStep = step - 1;
            
            // Valida lo step corrente prima di procedere
            if (!validateStep(currentStep)) {
                showValidationMessage('Correggi gli errori prima di procedere al passo successivo.', 'error');
                return;
            }
            
            // Nasconde tutti gli step
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('d-none');
            });
            
            // Mostra lo step target
            document.getElementById(`step-${step}-content`).classList.remove('d-none');
            
            // Aggiorna la navigazione
            document.querySelectorAll('.step-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`step-${step}-nav`).classList.add('active');
            
            // Se arriviamo allo step 3, aggiorna il riepilogo
            if (step === 3) {
                updateSummary();
            }
        }

        // Aggiungi validazione al caricamento pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Aggiungi listener di validazione per gli input RPO quando vengono creati
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.querySelector) {
                            const rpoInputs = node.querySelectorAll('.rpo-input');
                            rpoInputs.forEach(input => {
                                const backupId = input.id.replace('rpo-', '');
                                input.addEventListener('input', () => validateRPOInput(backupId));
                                input.addEventListener('blur', () => validateRPOInput(backupId));
                            });
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>
