<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Six Sigma Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;        /* Blu dominante Six Sigma */
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #ffff99;        /* Giallo per Test 2/3 */
            --danger-color: #ff0000;         /* Rosso per Test 1 */
            --light-bg: #fafafa;
            --dark-bg: #1e1e1e;
            --text-light: #2c3e50;
            --text-dark: #f5f5f5;
            --accent-blue: #007bff;          /* Blu accent Six Sigma */
            --card-light: #ffffff;
            --card-dark: #2d2d2d;
        }

        [data-theme="dark"] {
            --light-bg: var(--dark-bg);
            --text-light: var(--text-dark);
            --card-light: var(--card-dark);
            background-color: var(--dark-bg);
            color: var(--text-dark);
        }

        [data-theme="dark"] .card {
            background-color: var(--card-dark);
            border: 1px solid #404040;
            color: var(--text-dark);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .form-control {
            background-color: #404040;
            border-color: #555;
            color: var(--text-dark);
        }

        [data-theme="dark"] .form-control:focus {
            background-color: #404040;
            border-color: var(--accent-blue);
            color: var(--text-dark);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        [data-theme="dark"] .form-range::-webkit-slider-thumb {
            background: var(--accent-blue);
        }

        [data-theme="dark"] .form-range::-moz-range-thumb {
            background: var(--accent-blue);
        }

        [data-theme="dark"] .text-muted {
            color: #a0a0a0 !important;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-light);
            transition: all 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--accent-blue), #0056b3);
            padding: 2rem 0;
        }

        .config-card {
            background: var(--card-light);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 2rem;
        }

        [data-theme="dark"] .config-card {
            background: var(--card-dark);
            border: 1px solid #404040;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .step-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .step-item {
            display: flex;
            align-items: center;
            margin: 0 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .step-item.active {
            color: white;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            font-weight: bold;
        }

        .step-item.active .step-circle {
            background: white;
            color: var(--accent-blue);
        }

        .section-header {
            background: linear-gradient(45deg, var(--accent-blue), #0056b3);
            color: white;
            padding: 1.5rem;
            border-radius: 15px 15px 0 0;
            margin: 0;
        }

        .metric-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            background: var(--card-light);
        }

        .metric-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }

        [data-theme="dark"] .metric-card {
            background: var(--card-dark);
            border-color: #404040;
        }

        [data-theme="dark"] .metric-card:hover {
            border-color: var(--accent-blue);
        }

        .metric-header {
            background: var(--accent-blue);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .metric-icon {
            font-size: 1.2em;
            margin-right: 0.5rem;
        }

        .weight-slider {
            margin: 1rem 0;
        }

        .slider-container {
            position: relative;
            margin: 1rem 0;
        }

        .form-range {
            width: 100%;
            margin: 0.5rem 0;
        }

        .weight-display {
            background: var(--accent-blue);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .machine-section {
            margin-bottom: 3rem;
        }

        .machine-header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            font-size: 1.1em;
        }

        .validation-feedback {
            font-size: 0.875em;
            margin-top: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-blue), #0056b3);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            font-weight: 600;
        }

        .total-weight-indicator {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
        }

        [data-theme="dark"] .total-weight-indicator {
            background: #343a40;
            border-color: #495057;
            color: var(--text-dark);
        }

        .weight-valid {
            border-color: #28a745 !important;
            background-color: #d4edda !important;
        }

        .weight-invalid {
            border-color: #dc3545 !important;
            background-color: #f8d7da !important;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .config-actions {
            background: var(--card-light);
            padding: 2rem;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #dee2e6;
        }

        [data-theme="dark"] .config-actions {
            background: var(--card-dark);
            border-color: #404040;
        }

        .info-panel {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .test-legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .test-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .test-critical { background-color: #ff000020; color: #ff0000; }
        .test-warning { background-color: #ff800020; color: #ff8000; }
        .test-pending { background-color: #ffff9920; color: #b8860b; }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="btn btn-outline-light theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="main-container">
        <div class="container">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h1 class="text-white mb-2">
                        <i class="fas fa-chart-line me-2"></i>
                        Six Sigma Configuration
                    </h1>
                    <p class="text-white-50">Configura i pesi delle metriche per ogni macchina</p>
                </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-nav">
                <div class="step-item active">
                    <div class="step-circle">1</div>
                    <span>Configurazione Pesi</span>
                </div>
                <div class="step-item">
                    <div class="step-circle">2</div>
                    <span>Validazione</span>
                </div>
                <div class="step-item">
                    <div class="step-circle">3</div>
                    <span>Salvataggio</span>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="info-panel">
                        <h5><i class="fas fa-info-circle me-2"></i>Informazioni Configuration</h5>
                        <p class="mb-2">
                            Configura i pesi per ogni metrica (CPU, RAM, I/O Wait) per ciascuna macchina.
                            I pesi determinano l'importanza relativa di ogni metrica nel calcolo del P-Score finale.
                        </p>
                        <p class="mb-2">
                            <strong>üéØ Auto-Bilanciamento:</strong> Quando modifichi un peso, gli altri si regolano automaticamente 
                            per mantenere sempre la somma a 100%.
                        </p>
                        <div class="test-legend">
                            <div class="test-item test-critical">
                                <i class="fas fa-circle me-1"></i>
                                Test Critici (Rosso): Test 1, mR, Saturazione
                            </div>
                            <div class="test-item test-warning">
                                <i class="fas fa-circle me-1"></i>
                                Test Statistici (Arancione): Test 4, Test 8
                            </div>
                            <div class="test-item test-pending">
                                <i class="fas fa-circle me-1"></i>
                                Test Zone (Giallo): Test 2, Test 3
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="row">
                <div class="col-12">
                    <div class="config-card">
                        <div class="section-header">
                            <h4 class="mb-0">
                                <i class="fas fa-sliders-h me-2"></i>
                                Configurazione Pesi Metriche
                            </h4>
                        </div>

                        <div class="p-4">
                            <form id="configForm">
                                {% for machine in machines %}
                                <div class="machine-section">
                                    <div class="machine-header">
                                        <i class="fas fa-server me-2"></i>
                                        Macchina: {{ machine }}
                                    </div>

                                    <div class="row" id="machine-{{ machine }}">
                                        <!-- CPU Metric -->
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <div class="metric-header">
                                                    <span>
                                                        <i class="fas fa-microchip metric-icon"></i>
                                                        CPU Usage
                                                    </span>
                                                    <span class="weight-display" id="cpu-weight-{{ machine }}">
                                                        {{ "%.0f"|format(default_weights.cpu * 100) }}%
                                                    </span>
                                                </div>
                                                <div class="p-3">
                                                    <div class="slider-container">
                                                        <input type="range" 
                                                               class="form-range weight-slider" 
                                                               id="cpu-slider-{{ machine }}"
                                                               name="cpu_weight_{{ machine }}"
                                                               min="0" 
                                                               max="100" 
                                                               value="{{ default_weights.cpu * 100 }}"
                                                               oninput="updateWeight('cpu', '{{ machine }}', this.value)">
                                                        <div class="d-flex justify-content-between text-muted small">
                                                            <span>0%</span>
                                                            <span>100%</span>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        Criticit√†: <strong>Alta</strong> - Impatto diretto sulle performance
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- RAM Metric -->
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <div class="metric-header">
                                                    <span>
                                                        <i class="fas fa-memory metric-icon"></i>
                                                        RAM Usage
                                                    </span>
                                                    <span class="weight-display" id="ram-weight-{{ machine }}">
                                                        {{ "%.0f"|format(default_weights.ram * 100) }}%
                                                    </span>
                                                </div>
                                                <div class="p-3">
                                                    <div class="slider-container">
                                                        <input type="range" 
                                                               class="form-range weight-slider" 
                                                               id="ram-slider-{{ machine }}"
                                                               name="ram_weight_{{ machine }}"
                                                               min="0" 
                                                               max="100" 
                                                               value="{{ default_weights.ram * 100 }}"
                                                               oninput="updateWeight('ram', '{{ machine }}', this.value)">
                                                        <div class="d-flex justify-content-between text-muted small">
                                                            <span>0%</span>
                                                            <span>100%</span>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        Criticit√†: <strong>Media-Alta</strong> - Stabilit√† del sistema
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- I/O Wait Metric -->
                                        <div class="col-md-4">
                                            <div class="metric-card">
                                                <div class="metric-header">
                                                    <span>
                                                        <i class="fas fa-hdd metric-icon"></i>
                                                        I/O Wait
                                                    </span>
                                                    <span class="weight-display" id="io_wait-weight-{{ machine }}">
                                                        {{ "%.0f"|format(default_weights.io_wait * 100) }}%
                                                    </span>
                                                </div>
                                                <div class="p-3">
                                                    <div class="slider-container">
                                                        <input type="range" 
                                                               class="form-range weight-slider" 
                                                               id="io_wait-slider-{{ machine }}"
                                                               name="io_wait_weight_{{ machine }}"
                                                               min="0" 
                                                               max="100" 
                                                               value="{{ default_weights.io_wait * 100 }}"
                                                               oninput="updateWeight('io_wait', '{{ machine }}', this.value)">
                                                        <div class="d-flex justify-content-between text-muted small">
                                                            <span>0%</span>
                                                            <span>100%</span>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        Criticit√†: <strong>Media</strong> - Throughput applicazioni
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Total Weight Indicator -->
                                    <div class="total-weight-indicator" id="total-indicator-{{ machine }}">
                                        <strong>Peso Totale: <span id="total-weight-{{ machine }}">100</span>%</strong>
                                        <div class="validation-feedback d-none" id="validation-{{ machine }}">
                                            I pesi devono sommare a 100%
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </form>
                        </div>

                        <!-- Actions -->
                        <div class="config-actions">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-secondary w-100" onclick="resetToDefaults()">
                                        <i class="fas fa-undo me-2"></i>
                                        Reset Default
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-primary w-100" onclick="saveConfiguration()" id="saveBtn">
                                        <i class="fas fa-save me-2"></i>
                                        Salva Configurazione
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Dashboard -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <a href="/sixsigma" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>
                        Torna alla Selezione
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            document.getElementById('theme-icon').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-icon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

        // Global configuration data
        const machines = {{ machines | tojson }};
        const defaultWeights = {{ default_weights | tojson }};

        // Weight management with auto-balancing
        function updateWeight(metric, machine, value) {
            const percentage = Math.round(value);
            document.getElementById(`${metric}-weight-${machine}`).textContent = `${percentage}%`;
            
            // Auto-balance the other two sliders to maintain 100% total
            autoBalanceSliders(metric, machine, percentage);
            
            // Update total weight display
            updateTotalWeight(machine);
        }

        function autoBalanceSliders(changedMetric, machine, newValue) {
            const metrics = ['cpu', 'ram', 'io_wait'];
            const otherMetrics = metrics.filter(m => m !== changedMetric);
            
            // Get current values
            const currentValues = {};
            metrics.forEach(m => {
                currentValues[m] = parseInt(document.getElementById(`${m}-slider-${machine}`).value);
            });
            
            // Set the changed value
            currentValues[changedMetric] = newValue;
            
            // Calculate remaining percentage for the other two metrics
            const remaining = 100 - newValue;
            
            if (remaining >= 0) {
                // Get current sum of other metrics
                const otherSum = otherMetrics.reduce((sum, m) => sum + currentValues[m], 0);
                
                if (otherSum > 0) {
                    // Proportionally adjust the other metrics
                    otherMetrics.forEach(metric => {
                        const proportion = currentValues[metric] / otherSum;
                        const newOtherValue = Math.round(remaining * proportion);
                        
                        // Update slider and display
                        document.getElementById(`${metric}-slider-${machine}`).value = newOtherValue;
                        document.getElementById(`${metric}-weight-${machine}`).textContent = `${newOtherValue}%`;
                    });
                } else {
                    // If other metrics are 0, split remaining equally
                    const equalShare = Math.round(remaining / otherMetrics.length);
                    const remainder = remaining - (equalShare * (otherMetrics.length - 1));
                    
                    otherMetrics.forEach((metric, index) => {
                        const value = index === otherMetrics.length - 1 ? remainder : equalShare;
                        document.getElementById(`${metric}-slider-${machine}`).value = value;
                        document.getElementById(`${metric}-weight-${machine}`).textContent = `${value}%`;
                    });
                }
            }
        }

        function updateTotalWeight(machine) {
            const cpuValue = parseInt(document.getElementById(`cpu-slider-${machine}`).value);
            const ramValue = parseInt(document.getElementById(`ram-slider-${machine}`).value);
            const ioValue = parseInt(document.getElementById(`io_wait-slider-${machine}`).value);
            
            const total = cpuValue + ramValue + ioValue;
            const totalElement = document.getElementById(`total-weight-${machine}`);
            const indicatorElement = document.getElementById(`total-indicator-${machine}`);
            const validationElement = document.getElementById(`validation-${machine}`);
            
            totalElement.textContent = total;
            
            // Validation
            if (total === 100) {
                indicatorElement.className = 'total-weight-indicator weight-valid';
                validationElement.classList.add('d-none');
            } else {
                indicatorElement.className = 'total-weight-indicator weight-invalid';
                validationElement.classList.remove('d-none');
            }
            
            // Update save button state
            updateSaveButtonState();
        }

        function updateSaveButtonState() {
            let allValid = true;
            
            machines.forEach(machine => {
                const cpuValue = parseInt(document.getElementById(`cpu-slider-${machine}`).value);
                const ramValue = parseInt(document.getElementById(`ram-slider-${machine}`).value);
                const ioValue = parseInt(document.getElementById(`io_wait-slider-${machine}`).value);
                
                if (cpuValue + ramValue + ioValue !== 100) {
                    allValid = false;
                }
            });
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = !allValid;
            if (!allValid) {
                saveBtn.classList.add('btn-secondary');
                saveBtn.classList.remove('btn-primary');
            } else {
                saveBtn.classList.remove('btn-secondary');
                saveBtn.classList.add('btn-primary');
            }
        }

        function resetToDefaults() {
            machines.forEach(machine => {
                // Reset sliders
                document.getElementById(`cpu-slider-${machine}`).value = defaultWeights.cpu * 100;
                document.getElementById(`ram-slider-${machine}`).value = defaultWeights.ram * 100;
                document.getElementById(`io_wait-slider-${machine}`).value = defaultWeights.io_wait * 100;
                
                // Update displays
                updateWeight('cpu', machine, defaultWeights.cpu * 100);
                updateWeight('ram', machine, defaultWeights.ram * 100);
                updateWeight('io_wait', machine, defaultWeights.io_wait * 100);
            });
        }

        function saveConfiguration() {
            const configuration = {};
            
            machines.forEach(machine => {
                const cpuWeight = parseFloat(document.getElementById(`cpu-slider-${machine}`).value) / 100;
                const ramWeight = parseFloat(document.getElementById(`ram-slider-${machine}`).value) / 100;
                const ioWeight = parseFloat(document.getElementById(`io_wait-slider-${machine}`).value) / 100;
                
                configuration[machine] = {
                    cpu: cpuWeight,
                    ram: ramWeight,
                    io_wait: ioWeight
                };
            });
            
            // Send configuration to server
            fetch('/sixsigma/api/save_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configuration)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Configurazione salvata con successo!');
                    // Optional: redirect to dashboard
                    window.location.href = '/sixsigma';
                } else {
                    alert('‚ùå Errore nel salvataggio: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Errore di connessione');
            });
        }

        // Initialize total weights on page load
        document.addEventListener('DOMContentLoaded', function() {
            machines.forEach(machine => {
                updateTotalWeight(machine);
            });
        });
    </script>
</body>
</html>
